<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Service calls make your tests better</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Service calls make your tests better</h1>
</header>
<section data-field="subtitle" class="p-summary">
TL;DR: If all tests are mocked, you don’t know if your code really works, you only know that, theoretically, it is supposed to work if the…
</section>
<section data-field="body" class="e-content">
<section name="a59a" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c9fd" id="c9fd" class="graf graf--h3 graf--leading graf--title">Service calls make your tests better</h3><p name="ee8d" id="ee8d" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">TL;DR: If all tests are mocked, you don’t know if your code really works, you only know that, theoretically, it is supposed to work if the integrations adhere to the contract you expect.</strong></p><figure name="dd24" id="dd24" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 437px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 62.4%;"></div><img class="graf-image" data-image-id="0*iKjvNG4OVK47bauK.jpeg" data-width="700" data-height="437" data-is-featured="true" alt="Learning Javascript with Justin Fuller" src="https://cdn-images-1.medium.com/max/800/0*iKjvNG4OVK47bauK.jpeg"></div></figure><p name="250c" id="250c" class="graf graf--p graf-after--figure">Mocking, stubbing, or maybe — even better — <a href="https://medium.com/free-code-camp/simply-javascript-a-straightforward-intro-to-mocking-stubbing-and-interfaces-14e67ed6641a" data-href="https://medium.com/free-code-camp/simply-javascript-a-straightforward-intro-to-mocking-stubbing-and-interfaces-14e67ed6641a" class="markup--anchor markup--p-anchor" target="_blank">dependency inversion</a>, they can simplify testing and make your code easier to change, but can they cause problems too? Let’s see.</p><p name="fbfe" id="fbfe" class="graf graf--p graf-after--p">Take a look at this test where we are saving a file using an external file service.</p><figure name="d82f" id="d82f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 524px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 74.8%;"></div><img class="graf-image" data-image-id="0*y5AJuTRbi2HBrah3" data-width="1400" data-height="1047" src="https://cdn-images-1.medium.com/max/800/0*y5AJuTRbi2HBrah3"></div></figure><p name="9f43" id="9f43" class="graf graf--p graf-after--figure">Can you tell if this is a useful test?</p><p name="a769" id="a769" class="graf graf--p graf-after--p">Hint: it most likely isn’t going to ever catch any bugs. Let’s see if we can determine why not.</p><p name="02a1" id="02a1" class="graf graf--p graf-after--p">The first reason it won’t catch any bugs is that we are using a mock implementation of the drive service. So we won’t catch any errors if someone changes the drive service without changing the file uploader. If the drive service changes from <code class="markup--code markup--p-code">write</code> to <code class="markup--code markup--p-code">writeFile</code> our test won’t catch that.</p><p name="bd79" id="bd79" class="graf graf--p graf-after--p">Now, what about even further down the line? What if something changes with the actual drive server that we want to integrate with? We certainly won’t catch those errors because we aren’t ever making a call to it.</p><p name="c684" id="c684" class="graf graf--p graf-after--p">In the end the only thing we are truly testing is that the <code class="markup--code markup--p-code">uploadFile</code> method gives the <code class="markup--code markup--p-code">file</code> object to the <code class="markup--code markup--p-code">driveService</code>’s <code class="markup--code markup--p-code">write</code> function. We’ll catch an error if drive service uses the <code class="markup--code markup--p-code">file</code> object incorrectly, or if <code class="markup--code markup--p-code">fileUploader</code> stops giving the file directly to the drive service.</p><p name="8585" id="8585" class="graf graf--p graf-after--p">Unfortunately we will also have to update this test whenever we change how <code class="markup--code markup--p-code">fileUploader</code> and <code class="markup--code markup--p-code">driveService</code> interact.</p><p name="afaf" id="afaf" class="graf graf--p graf-after--p">So not only is the test brittle, it’s just not very useful. Further, in a typed language (Typescript) it would be completely useless since the compiler would catch these types of errors during compilation.</p><p name="1bbe" id="1bbe" class="graf graf--p graf-after--p">So, how can we make this test better? The test can become useful if it actually makes the service call to the drive server. Not the internal <code class="markup--code markup--p-code">DriveService</code> object, but to a real Drive Server.</p><p name="3451" id="3451" class="graf graf--p graf-after--p">Immediately you should be objecting, “My unit tests will take forever to run and become extremely brittle if I am making real service calls!” If you said that you are absolutely right. That kind of test is best served as an integration test.</p><h3 name="451f" id="451f" class="graf graf--h3 graf-after--p">Integration Tests</h3><p name="2c0c" id="2c0c" class="graf graf--p graf-after--h3">Integration tests will not be run as often as unit tests, but they should — at the very least — be run before integrating your changes into the code base. See what I did there? Integration tests run when you integrate.</p><p name="82ec" id="82ec" class="graf graf--p graf-after--p">Still, the problem exists, how could I realistically run all the servers needed for my application to function? Starting them up can be expensive, not to mention the data stores, managing ports, authentication, and everything else that goes into creating a fully-functioning system.</p><p name="a565" id="a565" class="graf graf--p graf-after--p">Take a look at this simple system diagram. It represents a very stripped-down version of the system in the example test from earlier.</p><figure name="8962" id="8962" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 626px; max-height: 241px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 38.5%;"></div><img class="graf-image" data-image-id="0*EByxzGkBFV-tC8L8" data-width="626" data-height="241" src="https://cdn-images-1.medium.com/max/800/0*EByxzGkBFV-tC8L8"></div></figure><p name="7f8d" id="7f8d" class="graf graf--p graf-after--figure">You can see that all we’re interested in here is testing the integration of our “File Service” with the external “Drive Service” that belongs to another team. In this case we’re not trying to run a full end to end test.</p><p name="8807" id="8807" class="graf graf--p graf-after--p">But what are we actually testing?</p><figure name="a1a9" id="a1a9" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 626px; max-height: 241px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 38.5%;"></div><img class="graf-image" data-image-id="0*c8sCS-H_FJxRSUyg" data-width="626" data-height="241" src="https://cdn-images-1.medium.com/max/800/0*c8sCS-H_FJxRSUyg"></div></figure><p name="fff8" id="fff8" class="graf graf--p graf-after--figure">Oops! Here, as shown in green, only the file service was tested. We wanted to test if our File Service and its connection to the Drive service are actually working. So instead of writing a mocked version on our end, we will look for a way to obtain a testable version of the drive service.</p><h3 name="9cd1" id="9cd1" class="graf graf--h3 graf-after--p"><strong class="markup--strong markup--h3-strong">Isolated Services</strong></h3><p name="ef2b" id="ef2b" class="graf graf--p graf-after--h3">One option is to create an isolated version of the Drive Service. Ideally this will be owned by the team that created the Drive Service. In order to ensure that the fake server is trustworthy they will run the same tests against both the fake server and the real server.</p><figure name="279d" id="279d" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 613px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 87.6%;"></div><img class="graf-image" data-image-id="0*Gp-SMfRFeoTXyimI" data-width="1126" data-height="986" src="https://cdn-images-1.medium.com/max/800/0*Gp-SMfRFeoTXyimI"></div></figure><p name="232d" id="232d" class="graf graf--p graf-after--figure">The above code represents a sample isolated server implementation. You can see that it is very similar to the real server implementation, except that it uses an in-memory data store instead of a real file storage device. It even uses port 0 to ensure that an <a href="https://en.wikipedia.org/wiki/Ephemeral_port" data-href="https://en.wikipedia.org/wiki/Ephemeral_port" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ephemeral port</a> is used, further increasing the stability of it’s tests.</p><p name="f833" id="f833" class="graf graf--p graf-after--p">Now that the Drive team is providing this isolated server, our integration tests can safely start it and use it during integration tests. Let’s rewrite that original test as an integration test and see if it becomes more useful.</p><figure name="9415" id="9415" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 666px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 95.1%;"></div><img class="graf-image" data-image-id="0*7I8V3PLQgOKOCv0w" data-width="1400" data-height="1332" src="https://cdn-images-1.medium.com/max/800/0*7I8V3PLQgOKOCv0w"></div></figure><p name="0887" id="0887" class="graf graf--p graf-after--figure">Now is our test more useful? Since we made the call to the real Drive Server api (even though it saves to a different storage device, the API and business logic remain the same) we will know if our integration breaks.</p><p name="7317" id="7317" class="graf graf--p graf-after--p">Even better, not only were we able to test what URL it returns, we were able to test if the content was saved as expected. Our test will actually tell us if file saving works!</p><figure name="aa22" id="aa22" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 626px; max-height: 241px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 38.5%;"></div><img class="graf-image" data-image-id="0*qeITxHrazRrTKg27" data-width="626" data-height="241" src="https://cdn-images-1.medium.com/max/800/0*qeITxHrazRrTKg27"></div></figure><p name="ad89" id="ad89" class="graf graf--p graf-after--figure">Look at our system diagram again. You can see in green the services that are being tested. This time we are testing the file service, the drive service, and, most importantly, the connection between them.</p><p name="9dc8" id="9dc8" class="graf graf--p graf-after--p">It isn’t realistic to expect that this set of tests will be run every time we change a line of code — that expectation is reserved for unit tests — but this test is still lightweight enough to run on each code check-in. Executing the integration test in this fashion will ensure that your main branch will have not only correct business logic, but also working integrations with other services.</p><h3 name="35cc" id="35cc" class="graf graf--h3 graf-after--p"><strong class="markup--strong markup--h3-strong">A fallback when an isolated service just isn’t possible</strong></h3><p name="55ec" id="55ec" class="graf graf--p graf-after--h3">Sometimes you really may have some kind of environment or build-time constraint that makes an isolated server impossible. If that’s the case then you could look to fake APIs as a fallback.</p><p name="07fb" id="07fb" class="graf graf--p graf-after--p">Remember, we’re still talking about integrations here — code that interacts with other services. You may have noticed the code contained two Drive related entities: <code class="markup--code markup--p-code">DriveServer</code> and <code class="markup--code markup--p-code">DriveService</code>. The <code class="markup--code markup--p-code">DriveServer</code> was the actual server that belongs to the third party. We were using their in-memory version to test our integration with their service. The <code class="markup--code markup--p-code">DriveService</code> is an API that knows how to interact with a <code class="markup--code markup--p-code">DriveServer</code>. This API also belongs to the Drive team.</p><p name="b7d4" id="b7d4" class="graf graf--p graf-after--p">Thankfully they understand that not everyone can use their isolated in-memory server, so they also created a fake version of their API. Take a look.</p><figure name="6ee1" id="6ee1" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 530px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75.7%;"></div><img class="graf-image" data-image-id="0*nRPxOUoRRxlyo_bD" data-width="1160" data-height="878" src="https://cdn-images-1.medium.com/max/800/0*nRPxOUoRRxlyo_bD"></div></figure><p name="a159" id="a159" class="graf graf--p graf-after--figure">This <code class="markup--code markup--p-code">FakeDriveService</code> is an implementation that the Drive Team could provide to anyone who uses their service. They are saying “If you test with the <code class="markup--code markup--p-code">FakeDriveService</code> you can trust that the real <code class="markup--code markup--p-code">DriveService</code> will work. We run tests against both to ensure that they work the same.”</p><p name="98da" id="98da" class="graf graf--p graf-after--p">This implementation is obviously even lighter than the isolated server, so what’s the drawback? Let’s refer, once again, to our system diagram.</p><figure name="c110" id="c110" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 626px; max-height: 241px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 38.5%;"></div><img class="graf-image" data-image-id="0*-HnhLFl8kcpFkPd9" data-width="626" data-height="241" src="https://cdn-images-1.medium.com/max/800/0*-HnhLFl8kcpFkPd9"></div></figure><p name="0d9c" id="0d9c" class="graf graf--p graf-after--figure">While we are technically testing the connection <em class="markup--em markup--p-em">mechanism </em>we aren’t actually touching the <code class="markup--code markup--p-code">DriveService</code>. Our test is built on trust, not actual verification. The trust is that the fake service really does work the same as the full service. In many scenarios this could be good enough, but if you have a production critical system you may need a better guarantee.</p><p name="859d" id="859d" class="graf graf--p graf-after--p">Still, this test is better than the original mock function that we started with. That mock function was completely untrustworthy to the point that, I would argue, it actually tricked us into thinking we were safe from bugs, but in reality we had no idea. Our tests will now have to change if the <code class="markup--code markup--p-code">DriveService</code> changes. In that first mock scenario we wouldn’t have had to change our tests, it would have tricked us into thinking that our code still worked, even when it was broken due to an API change.</p><h3 name="0d39" id="0d39" class="graf graf--h3 graf-after--p"><strong class="markup--strong markup--h3-strong">Credits</strong></h3><p name="d006" id="d006" class="graf graf--p graf-after--h3">This post was directly inspired by posts that I recently found in Google’s “Testing on the toilet” blog. I wanted to reframe the idea with JavaScript code. Please see the links below to read their original posts.</p><p name="1d61" id="1d61" class="graf graf--p graf-after--p">Exercise service call</p><p name="186f" id="186f" class="graf graf--p graf-after--p">Fakes:</p><p name="3b4b" id="3b4b" class="graf graf--p graf-after--p"><a href="https://testing.googleblog.com/2013/06/testing-on-toilet-fake-your-way-to.html" data-href="https://testing.googleblog.com/2013/06/testing-on-toilet-fake-your-way-to.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://testing.googleblog.com/2013/06/testing-on-toilet-fake-your-way-to.html</a></p><p name="1e81" id="1e81" class="graf graf--p graf-after--p">Hermetic Servers:</p><p name="9a6a" id="9a6a" class="graf graf--p graf-after--p"><a href="https://testing.googleblog.com/2012/10/hermetic-servers.html" data-href="https://testing.googleblog.com/2012/10/hermetic-servers.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://testing.googleblog.com/2012/10/hermetic-servers.html</a></p><h4 name="f527" id="f527" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">Disclaimer</strong></h4><p name="f166" id="f166" class="graf graf--p graf-after--h4">The views and suggestions here are my own, not my employer’s. I in no way intend to represent them through this post.</p><h4 name="8310" id="8310" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">Get in touch</strong></h4><p name="2e57" id="2e57" class="graf graf--p graf-after--h4 graf--trailing">I’d love to hear from you. Please feel free to reach out to me on <a href="https://www.linkedin.com/in/justin-fuller-8726b2b1/" data-href="https://www.linkedin.com/in/justin-fuller-8726b2b1/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">LinkedIn</a> or <a href="https://github.com/justinDFuller/" data-href="https://github.com/justinDFuller/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Github</a>.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@justindanielfuller" class="p-author h-card">Justin Fuller</a> on <a href="https://medium.com/p/457bed6da6db"><time class="dt-published" datetime="2019-07-19T01:53:29.367Z">July 19, 2019</time></a>.</p><p><a href="https://medium.com/@justindanielfuller/service-calls-make-your-tests-better-457bed6da6db" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 19, 2019.</p></footer></article></body></html>