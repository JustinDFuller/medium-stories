<article class="h-entry">
<header>
<h1 class="p-name">Introducing Promise-Funnel</h1>
</header>
<section data-field="subtitle" class="p-summary">
Today I’d like to give a quick overview of a new library that is made to help you manage the flow of your application.
</section>
<section data-field="body" class="e-content">
<section name="b81f" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="f7ea" id="f7ea" class="graf graf--h3 graf--leading graf--title">Introducing Promise-Funnel</h3><p name="303f" id="303f" class="graf graf--p graf-after--h3">Today I’d like to give a quick overview of a new library that is made to help you manage the flow of your application.</p><figure name="4f40" id="4f40" class="graf graf--figure graf--layoutOutsetLeft graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 525px; max-height: 282px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 53.6%;"></div><img class="graf-image" data-image-id="1*tZhpkuhrEQagrdZdZJ5WVQ.png" data-width="906" data-height="486" src="https://cdn-images-1.medium.com/max/600/1*tZhpkuhrEQagrdZdZJ5WVQ.png"></div></figure><p name="9e1e" id="9e1e" class="graf graf--p graf-after--figure">The use case was inspired by two particular problems I had recently.</p><p name="b395" id="b395" class="graf graf--p graf-after--p">In problem one I had a React App that authenticates both immediately, and on a regular interval. During each authentication the requests to retrieve data needed to wait. I did not want to receive or show unauthenticated response errors during this time.</p><p name="580e" id="580e" class="graf graf--p graf-after--p">In the second problem I had a database micro service that immediately invoked functions that send queries, but it needed to complete the connection to the database before any queries are actually sent.</p><p name="3aac" id="3aac" class="graf graf--p graf-after--p graf--trailing">This problem seems to be somewhat common. That’s where <code class="markup--code markup--p-code">promise-funnel</code> comes in! You can check it out <a href="https://www.npmjs.com/package/promise-funnel" data-href="https://www.npmjs.com/package/promise-funnel" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">on NPM</a>.</p></div></div></section><section name="1edb" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="19e7" id="19e7" class="graf graf--h4 graf--leading">Concepts</h4><p name="2f5b" id="2f5b" class="graf graf--p graf-after--h4">Promise-funnel is a very tiny (4kb) and a very simple library. It exports three functions.</p><p name="7fb9" id="7fb9" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Wrap: </strong>Any function that you want to be funneled must be wrapped.</p><p name="3c9d" id="3c9d" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Cork: </strong>To pause functions from executing you can cork the funnel. All function executions will collect so that they can run later.</p><p name="9930" id="9930" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Uncork: </strong>To begin execution again, and execute every function that should have run while the funnel was corked, you can uncork the funnel.</p><p name="2f26" id="2f26" class="graf graf--p graf-after--p graf--trailing">When combining these simple concepts we are able to create a powerful control-flow for our application!</p></div></div></section><section name="2539" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="4d56" id="4d56" class="graf graf--h4 graf--leading">How to use it</h4><p name="2841" id="2841" class="graf graf--p graf-after--h4">Here’s how you might use it with a database application that needs to connect before sending any queries.</p><figure name="3858" id="3858" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/JustinDFuller/a334841f01192fc33ad436c1d8db85a5.js"></script></figure><p name="263b" id="263b" class="graf graf--p graf-after--figure">You can see that queries were immediately corked and were only uncorked when the database connection was successful. This means that the service can immediately accept requests, but it won’t execute any queries until the database connection happens!</p><p name="5b7e" id="5b7e" class="graf graf--p graf-after--p">Now let’s look at the authentication example that I mentioned earlier.</p><figure name="1e6d" id="1e6d" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/JustinDFuller/1bdcf88233f2b7e1966775ebaa2497ec.js"></script></figure><p name="b633" id="b633" class="graf graf--p graf-after--figure">Every five minutes the user is logged in again. While login is happening every user request would fail. So instead of letting that happen, we’ve corked the fetch requests until login is complete. Now the user won’t be stopped by authentication.. although they might be delayed!</p><p name="c78a" id="c78a" class="graf graf--p graf-after--p">In case you’re wondering, <code class="markup--code markup--p-code">createFunnel</code> will create a new funnel instance each time. This means that you can safely funnel different actions separately.</p><h4 name="f277" id="f277" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">Using your own Promises</strong></h4><p name="eadb" id="eadb" class="graf graf--p graf-after--h4">Not every environment has Promises natively. If you want to use a library like Bluebird with <code class="markup--code markup--p-code">promise-funnel</code>, you can!</p><figure name="89e4" id="89e4" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/JustinDFuller/5cb609d74f417ccf85dd920c53b49569.js"></script></figure><h4 name="6877" id="6877" class="graf graf--h4 graf-after--figure">The Promise Part</h4><p name="429f" id="429f" class="graf graf--p graf-after--h4">So far we haven’t really seen how a Promise is used by this library. A function won’t execute immediately when both the function is wrapped and the funnel is corked. A <code class="markup--code markup--p-code">Promise</code> is returned instead. It will resolve or reject only when the funnel is uncorked.</p><figure name="3c5e" id="3c5e" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/JustinDFuller/c7fb196332a50dcc4b8c5bafa2addb85.js"></script></figure><p name="2ae4" id="2ae4" class="graf graf--p graf-after--figure">The code snippet above should show that uncorking the funnel will resolve the promise that was returned by the wrapped function.</p><p name="78be" id="78be" class="graf graf--p graf-after--p graf--trailing">This means that any functions that uses <code class="markup--code markup--p-code">await</code> on a wrapped function or uses <code class="markup--code markup--p-code">.then().catch()</code> on a wrapped function will not continue until the funnel uncorks.</p></div></div></section><section name="283c" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="f7a5" id="f7a5" class="graf graf--p graf--leading">There you have it! <code class="markup--code markup--p-code">promise-funnel</code> is a tiny library, but I hope you all can find it useful.</p><p name="e07c" id="e07c" class="graf graf--p graf-after--p">To install it you can use the command:</p><p name="96c7" id="96c7" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code">npm install promise-funnel --save</code></p><p name="fe8c" id="fe8c" class="graf graf--p graf-after--p">You can also view the source code here: <a href="https://github.com/JustinDFuller/promise-funnel" data-href="https://github.com/JustinDFuller/promise-funnel" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://github.com/JustinDFuller/promise-funne</a>l</p><h4 name="5e9c" id="5e9c" class="graf graf--h4 graf-after--p">Feedback</h4><p name="c68e" id="c68e" class="graf graf--p graf-after--h4">This is a brand new library and can obviously still be improved. Do you have suggestions? For example, maybe it would benefit from optionally uncorking with only a certain amount of concurrency to avoid large bursts. There could also be other ways to accomplish what promise-funnel is supposed to. Feel free to share suggestions and alternative tools in the comments!</p><figure name="5de0" id="5de0" class="graf graf--figure graf-after--p graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 350px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 50%;"></div><a href="https://goo.gl/w4Pbea" data-href="https://goo.gl/w4Pbea" class="graf-imageAnchor" data-action="image-link" data-action-observe-only="true"><img class="graf-image" data-image-id="1*PZjwR1Nbluff5IMI6Y1T6g@2x.png" data-width="1400" data-height="700" src="https://cdn-images-1.medium.com/max/800/1*PZjwR1Nbluff5IMI6Y1T6g@2x.png"></a></div></figure></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@justindanielfuller" class="p-author h-card">Justin Fuller</a> on <a href="https://medium.com/p/93e7d46ceb31"><time class="dt-published" datetime="2018-08-23T10:56:01.753Z">August 23, 2018</time></a>.</p><p><a href="https://medium.com/@justindanielfuller/introducing-promise-funnel-93e7d46ceb31" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 2, 2018.</p></footer></article>